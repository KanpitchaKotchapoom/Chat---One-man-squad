<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Realtime Chat Rooms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div
      id="chatPage"
      class="w-full max-w-5xl h-[90vh] bg-white rounded-2xl shadow-xl overflow-hidden flex"
    >
      <!-- Sidebar -->
      <div class="w-1/3 bg-gray-50 border-r flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-700">üóÇ ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</h2>
          <button
            id="newRoomBtn"
            class="text-sm bg-teal-500 text-white px-3 py-1 rounded-lg hover:bg-teal-600"
          >
            + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á
          </button>
        </div>
        <ul id="roomList" class="flex-1 overflow-y-auto divide-y"></ul>
        <div class="p-3 border-t text-center text-sm text-gray-500">
          üë§ <span id="userDisplay"></span>
        </div>
      </div>

      <!-- Main Chat -->
      <div class="flex-1 flex flex-col">
        <div class="flex justify-between items-center p-4 border-b bg-gray-50">
          <div>
            <h2 id="roomHeader" class="text-lg font-semibold text-gray-700">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó
            </h2>
            <p id="roomOwner" class="text-sm text-gray-500"></p>
          </div>
          <div class="flex items-center space-x-2">
            <span id="roomUsers" class="text-sm text-gray-600"></span>
            <button
              id="clearBtn"
              class="hidden bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 text-sm"
            >
              üßπ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
            </button>
            <button
              id="deleteRoomBtn"
              class="hidden bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm"
            >
              üóëÔ∏è ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á
            </button>
            <button
              id="logoutBtn"
              class="bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 text-sm"
            >
              Logout
            </button>
          </div>
        </div>

        <ul id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white"></ul>

        <form id="form" class="p-4 border-t bg-gray-50 flex">
          <input
            id="input"
            autocomplete="off"
            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
            class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
          />
          <button
            type="submit"
            class="ml-3 bg-teal-600 text-white px-4 py-2 rounded-full hover:bg-teal-700"
          >
            ‡∏™‡πà‡∏á
          </button>
        </form>
      </div>
    </div>

    <script>

      $(function () {
        const socket = io();
        socket.on("connect", () => console.log("‚úÖ Connected to server"));
      socket.on("disconnect", () => console.log("‚ùå Disconnected from server"));
        let username = sessionStorage.getItem("username");
        let currentRoom = null;

        if (!username) {
          location.href = "/login";
          return;
        }
        $("#userDisplay").text(username);
        
        socket.emit("get_rooms");

        socket.on("room_list", (rooms) => {
            $("#roomList").empty();
            rooms.forEach((room) => {
                const li = $(`<li class="p-3 cursor-pointer hover:bg-teal-50 flex justify-between items-center">
                    <span>${room.name}</span>
                    <span class="text-xs text-gray-500">üëë ${room.owner}</span>
                </li>`);
                li.click(() => joinRoom(room.name));
                $("#roomList").append(li);
            });
        });

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ---
        $("#newRoomBtn").click(() => {
          const roomName = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà:");
          if (roomName) {
            console.log("üì§ create_room event sent:", roomName, username);
            socket.emit("create_room", { room: roomName, owner: username });
          }
        });

        // --- ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á ---
        function joinRoom(room) {
          currentRoom = room;
          $("#messages").empty();
          $("#roomHeader").text(`üí¨ ‡∏´‡πâ‡∏≠‡∏á: ${room}`);
          socket.emit("join_room", { room });
        }

        // --- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ---
        function appendMessage(msg) {
            const isOwn = msg.user === username;

            const li = $("<li>")
                .addClass(
                    "p-2 rounded-lg " +
                    (isOwn ? "bg-teal-50 text-right" : "bg-gray-50 text-left")
                );

            const nameColor = isOwn ? "text-teal-700" : "text-gray-700";
            const bubbleColor = isOwn ? "bg-teal-100" : "bg-gray-100";

            li.html(`
                <div class="inline-block px-3 py-1 rounded-xl ${bubbleColor}">
                    <span class="font-semibold ${nameColor}">[${msg.user}]</span>
                    <span>: ${msg.text}</span>
                </div>
            `);

            $("#messages").append(li);
            $("#messages").scrollTop($("#messages")[0].scrollHeight);
        }

        socket.on("receive_message", appendMessage);

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ---
        socket.on("load_history", (history) => {
            $("#messages").empty();
            history.forEach(appendMessage);
        });
        // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á ---
        socket.on("room_info", (info) => {
            $("#roomOwner").text(`üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: ${info.owner}`);
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö/‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
            if (info.owner === username) {
                $("#clearBtn, #deleteRoomBtn").show();
            } else {
                $("#clearBtn, #deleteRoomBtn").hide();
            }
        });

        // --- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ---
        $("#form").submit((e) => {
            e.preventDefault();
            const text = $("#input").val().trim();
            if (text && currentRoom) {
                socket.emit("send_message", { text, room: currentRoom });
                $("#input").val("");
            }
        });

        // --- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó ---
        $("#clearBtn").click(() => {
            if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                socket.emit("clear_history", { room: currentRoom });
            }
        });

        socket.on("clear_history_response", () => {
            $("#messages").empty();
        });

        // --- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ---
        $("#deleteRoomBtn").click(() => {
            if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                socket.emit("delete_room", { room: currentRoom });
                $("#messages").empty();
                $("#roomHeader").text("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó");
                $("#roomOwner").text("");
                $("#clearBtn, #deleteRoomBtn").hide();
                socket.emit("get_rooms");
            }
        });

        // --- Logout ---
        $("#logoutBtn").click(() => {
            sessionStorage.removeItem("username");
            socket.emit("logout");
            location.href = "/login";
        });


        // --- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ---
        socket.on("room_users", (users) => {
            $("#roomUsers").text(`üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á: ${users.join(", ")}`);
        });

        // --- ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó ---
        socket.on("history_cleared", () => {
          $("#messages").empty();
        });

        socket.on("connect", () => {
          console.log("‚úÖ Connected to server");
          const username = sessionStorage.getItem("username");
          if (username) {
            // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á server ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ user ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£‡∏´‡∏•‡∏±‡∏á reconnect
            socket.emit("reconnect_login", { username });
          }
        });
      });
    </script>
  </body>
</html>
